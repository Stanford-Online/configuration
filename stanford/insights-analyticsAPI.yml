---
- name: Bootstrap instance(s)
  hosts: all
  gather_facts: no
  become: True
  roles:
    - python

- name: Deploy analytics related services (except the pipeline)
  hosts: all
  become: True
  gather_facts: True
  vars:
    migrate_db: "yes"
    disable_edx_services: false
    ENABLE_DATADOG: False
    ENABLE_SPLUNKFORWARDER: False
    ENABLE_NEWRELIC: False
    mysql_debian_pkgs:
      - "mysql-server-5.6"
      - python-mysqldb
    EDXAPP_LMS_BASE_SCHEME: "https"
    EDXAPP_LMS_BASE: "cme.class.stanford.edu"
    EDXAPP_CMS_BASE: "studio.cme.class.stanford.edu"


  vars_files:
    - "{{ secure_dir }}/vars/{{ env }}/vars-analytics-api.yml"
    - "{{ secure_dir }}/vars/{{ env }}/vars-insights.yml"
    - "{{ secure_dir }}/vars/{{ env }}/vars-jenkins.yml"

#  pre_tasks:
#    - debug:
#        msg: "INSIGHTS_CONFIG: {{ INSIGHTS_CONFIG }}"

  roles:
    - aws
    - security
    - mysql
    - edxlocal
    - analytics_api
    - role: nginx
      nginx_sites:
        - insights
    - insights
    - role: postfix_queue
      when: POSTFIX_QUEUE_EXTERNAL_SMTP_HOST != ''
  tasks:
    - name: 'Install libffi-dev'
      apt: name=libffi-dev state=present
    - name: 'Install make'
      apt: name=make state=present
